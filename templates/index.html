<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2980b9;
            --secondary-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Roboto', sans-serif;
            color: var(--dark-text);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(41, 128, 185, 0.25);
        }

        .nav-pills .nav-link.active {
            background: var(--primary-color);
            border-radius: 25px;
        }

        .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .nav-pills .nav-link:hover {
            background: rgba(41, 128, 185, 0.1);
        }

        .alert {
            border: none;
            border-radius: 10px;
        }

        .spinner-border {
            color: var(--primary-color);
        }

        .modal-content {
            border-radius: 15px;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }

        @media (max-width: 768px) {
            .card {
                margin-bottom: 1rem;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-coins me-2"></i>
                Token Management System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="exportData()">
                            <i class="fas fa-download me-1"></i>Export
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showAbout()">
                            <i class="fas fa-info-circle me-1"></i>About
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Tab Navigation -->
        <ul class="nav nav-pills mb-4 justify-content-center" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="data-tab" data-bs-toggle="pill" data-bs-target="#data-content" type="button">
                    <i class="fas fa-database me-2"></i>Data Management
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="filter-tab" data-bs-toggle="pill" data-bs-target="#filter-content" type="button">
                    <i class="fas fa-filter me-2"></i>Token Filter
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="agent-tab" data-bs-toggle="pill" data-bs-target="#agent-content" type="button">
                    <i class="fas fa-user-tie me-2"></i>Agent Reports
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="executive-tab" data-bs-toggle="pill" data-bs-target="#executive-content" type="button">
                    <i class="fas fa-user-shield me-2"></i>Executive Reports
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profit-tab" data-bs-toggle="pill" data-bs-target="#profit-content" type="button">
                    <i class="fas fa-chart-line me-2"></i>Profit Analysis
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Data Management Tab -->
            <div class="tab-pane fade show active" id="data-content">
                <div class="row">
                    <!-- Add/Edit Form -->
                    <div class="col-12 col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add New Token</h5>
                            </div>
                            <div class="card-body">
                                <form id="tokenForm">
                                    <input type="hidden" id="tokenId">
                                    
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-control" id="date" required>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Completion Date</label>
                                            <input type="date" class="form-control" id="completionDate">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label class="form-label">Location</label>
                                            <select class="form-select" id="location" onchange="updateSubLocationField()">
                                                <option value="India">India</option>
                                                <option value="International">International</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label" id="subLocationLabel">City</label>
                                            <input type="text" class="form-control" id="subLocation" placeholder="Enter city...">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Token</label>
                                        <input type="text" class="form-control" id="token" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Password</label>
                                        <input type="text" class="form-control" id="password">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Client Name</label>
                                        <input type="text" class="form-control" id="clientName" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Contact</label>
                                        <input type="text" class="form-control" id="contact">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Who Will Ship</label>
                                        <input type="text" class="form-control" id="whoWillShip">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Client Status</label>
                                        <select class="form-select" id="contactedClient">
                                            <option value="Contacted client">Contacted client</option>
                                            <option value="Biometric Completed">Biometric Completed</option>
                                            <option value="Visited but server down">Visited but server down</option>
                                            <option value="Delivered">Delivered</option>
                                            <option value="Pickup booked">Pickup booked</option>
                                            <option value="Device shipped">Device shipped</option>
                                            <option value="Forwaded to executive">Forwaded to executive</option>
                                            <option value="Client replied">Client replied</option>
                                            <option value="Not msg clnt">Not msg clnt</option>
                                            <option value="Client NR">Client NR</option>
                                            <option value="Asked pcts">Asked pcts</option>
                                            <option value="Laptop not available">Laptop not available</option>
                                            <option value="Failed">Failed</option>
                                            <option value="Lost">Lost</option>
                                        </select>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label class="form-label">Status</label>
                                            <select class="form-select" id="status">
                                                <option value="Not Completed">Not Completed</option>
                                                <option value="Completed">Completed</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Forwarded</label>
                                            <select class="form-select" id="forwarded">
                                                <option value="Not Done">Not Done</option>
                                                <option value="Done">Done</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label class="form-label">Charges</label>
                                            <input type="number" class="form-control" id="charges" step="0.01" onchange="calculateAmounts()">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Payment Received</label>
                                            <input type="number" class="form-control" id="paymentReceived" step="0.01" onchange="calculateAmounts()">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label class="form-label">Amount Due</label>
                                            <input type="number" class="form-control" id="amountDue" readonly>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Executive Charges</label>
                                            <input type="number" class="form-control" id="chargesToExecutive" step="0.01" onchange="calculateAmounts()">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label class="form-label">Agent Name</label>
                                            <input type="text" class="form-control" id="agentName">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Executive Name</label>
                                            <input type="text" class="form-control" id="executiveName" value="Ramnath">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label class="form-label">Margin</label>
                                            <input type="number" class="form-control" id="margin" readonly>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Process By</label>
                                            <select class="form-select" id="processBy">
                                                <option value="Doorstep">Doorstep</option>
                                                <option value="Centre Visit">Centre Visit</option>
                                                <option value="Device">Device</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i><span id="submitBtnText">Add Token</span>
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                            <i class="fas fa-undo me-2"></i>Reset Form
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="col-12 col-lg-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Token Data</h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-light btn-sm" onclick="refreshData()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="btn btn-outline-light btn-sm" onclick="exportData()">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filters -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="searchInput" placeholder="Search tokens...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="locationFilter" onchange="filterData()">
                                            <option value="">All Locations</option>
                                            <option value="India">India</option>
                                            <option value="International">International</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="statusFilter" onchange="filterData()">
                                            <option value="">All Status</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Not Completed">Not Completed</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Loading Spinner -->
                                <div id="loadingSpinner" class="text-center d-none">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>

                                <!-- Data Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover" id="dataTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Date</th>
                                                <th>Location</th>
                                                <th>Token</th>
                                                <th>Client Name</th>
                                                <th>Status</th>
                                                <th>Charges</th>
                                                <th>Amount Due</th>
                                                <th>Agent</th>
                                                <th>Executive</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Token Filter Tab -->
            <div class="tab-pane fade" id="filter-content">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Advanced Token Filtering</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="filterStatus">
                                    <option value="">All</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Not Completed">Not Completed</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Location</label>
                                <select class="form-select" id="filterLocation">
                                    <option value="">All</option>
                                    <option value="India">India</option>
                                    <option value="International">International</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="filterFromDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="filterToDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Agent</label>
                                <select class="form-select" id="filterAgent">
                                    <option value="">All Agents</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Executive</label>
                                <select class="form-select" id="filterExecutive">
                                    <option value="">All Executives</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-12">
                                <button class="btn btn-primary me-2" onclick="applyFilters()">
                                    <i class="fas fa-filter me-1"></i>Apply Filters
                                </button>
                                <button class="btn btn-secondary me-2" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear Filters
                                </button>
                                <button class="btn btn-success" onclick="exportFilteredData()">
                                    <i class="fas fa-download me-1"></i>Export Results
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped" id="filteredTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Date</th>
                                        <th>Location</th>
                                        <th>City/Country</th>
                                        <th>Token</th>
                                        <th>Client Name</th>
                                        <th>Status</th>
                                        <th>Charges</th>
                                        <th>Amount Due</th>
                                        <th>Agent</th>
                                        <th>Executive</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="filteredTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Reports Tab -->
            <div class="tab-pane fade" id="agent-content">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Agent Payment Reports</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Agent</label>
                                <select class="form-select" id="reportAgent" required>
                                    <option value="">Select Agent</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="reportAgentStatus">
                                    <option value="All">All</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Incomplete">Incomplete</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="reportAgentFromDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="reportAgentToDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button class="btn btn-primary" onclick="generateAgentReport()">
                                        <i class="fas fa-chart-bar me-1"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-success" onclick="bulkApplyAgentPayment()">
                                        <i class="fas fa-money-check-alt me-1"></i>Apply Payment (All)
                                    </button>
                                    <button class="btn btn-info" onclick="markAllCompleted('agent')">
                                        <i class="fas fa-check-circle me-1"></i>Mark All Completed
                                    </button>
                                    <button class="btn btn-warning" onclick="exportAgentReport()">
                                        <i class="fas fa-file-export me-1"></i>Export Report
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped" id="agentReportTable">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllAgent" onchange="toggleSelectAll('agent')"></th>
                                        <th>Date</th>
                                        <th>Completion Date</th>
                                        <th>Location</th>
                                        <th>Token</th>
                                        <th>Client Name</th>
                                        <th>Charges</th>
                                        <th>Amount Due</th>
                                        <th>Status</th>
                                        <th>Payment Applied</th>
                                    </tr>
                                </thead>
                                <tbody id="agentReportBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Executive Reports Tab -->
            <div class="tab-pane fade" id="executive-content">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Executive Payment Reports</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Executive</label>
                                <select class="form-select" id="reportExecutive" required>
                                    <option value="">Select Executive</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="reportExecutiveStatus">
                                    <option value="All">All</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Incomplete">Incomplete</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="reportExecutiveFromDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="reportExecutiveToDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button class="btn btn-primary" onclick="generateExecutiveReport()">
                                        <i class="fas fa-chart-bar me-1"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-success" onclick="bulkApplyExecutivePayment()">
                                        <i class="fas fa-money-check-alt me-1"></i>Apply Payment (All)
                                    </button>
                                    <button class="btn btn-info" onclick="markAllCompleted('executive')">
                                        <i class="fas fa-check-circle me-1"></i>Mark All Completed
                                    </button>
                                    <button class="btn btn-warning" onclick="exportExecutiveReport()">
                                        <i class="fas fa-file-export me-1"></i>Export Report
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped" id="executiveReportTable">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllExecutive" onchange="toggleSelectAll('executive')"></th>
                                        <th>Date</th>
                                        <th>Completion Date</th>
                                        <th>Location</th>
                                        <th>Token</th>
                                        <th>Client Name</th>
                                        <th>Executive Charges</th>
                                        <th>Margin</th>
                                        <th>Status</th>
                                        <th>Payment Applied</th>
                                    </tr>
                                </thead>
                                <tbody id="executiveReportBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profit Analysis Tab -->
            <div class="tab-pane fade" id="profit-content">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Profit Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">Agent</label>
                                <select class="form-select" id="profitAgent">
                                    <option value="All">All Agents</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Location</label>
                                <select class="form-select" id="profitLocation">
                                    <option value="All">All</option>
                                    <option value="India">India</option>
                                    <option value="International">International</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="profitStatus">
                                    <option value="All">All</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Not Completed">Not Completed</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="profitFromDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="profitToDate">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button class="btn btn-primary" onclick="generateProfitReport()">
                                        <i class="fas fa-search me-1"></i>Analyze
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Profit Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 id="totalProfit">₹0</h4>
                                        <p class="mb-0">Total Profit</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4 id="totalRevenue">₹0</h4>
                                        <p class="mb-0">Total Revenue</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h4 id="totalTokens">0</h4>
                                        <p class="mb-0">Total Tokens</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h4 id="avgProfit">₹0</h4>
                                        <p class="mb-0">Avg Profit/Token</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped" id="profitTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Token</th>
                                        <th>Location</th>
                                        <th>Agent</th>
                                        <th>Revenue</th>
                                        <th>Executive Charges</th>
                                        <th>Profit</th>
                                        <th>Margin %</th>
                                    </tr>
                                </thead>
                                <tbody id="profitTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Token</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Edit form will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let allTokens = [];
        let filteredTokens = [];
        let agents = [];
        let executives = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadAgentsAndExecutives();
            loadData();
            setDefaultDates();
            
            // Set up search functionality
            document.getElementById('searchInput').addEventListener('input', debounce(filterData, 300));
        });

        // Set default dates to today
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('completionDate').value = today;
            document.getElementById('reportAgentFromDate').value = today;
            document.getElementById('reportAgentToDate').value = today;
            document.getElementById('reportExecutiveFromDate').value = today;
            document.getElementById('reportExecutiveToDate').value = today;
            document.getElementById('profitFromDate').value = today;
            document.getElementById('profitToDate').value = today;
        }

        // Load agents and executives for dropdowns
        async function loadAgentsAndExecutives() {
            try {
                const [agentsResponse, executivesResponse] = await Promise.all([
                    fetch('/api/agents'),
                    fetch('/api/executives')
                ]);
                
                agents = await agentsResponse.json();
                executives = await executivesResponse.json();
                
                populateDropdowns();
            } catch (error) {
                console.error('Error loading agents and executives:', error);
                showAlert('Error loading agents and executives', 'danger');
            }
        }

        // Populate dropdowns with agents and executives
        function populateDropdowns() {
            const agentSelects = ['filterAgent', 'reportAgent', 'profitAgent'];
            const executiveSelects = ['filterExecutive', 'reportExecutive'];

            agentSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">All Agents</option>';
                agents.forEach(agent => {
                    select.innerHTML += `<option value="${agent}">${agent}</option>`;
                });
            });

            executiveSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">All Executives</option>';
                executives.forEach(executive => {
                    select.innerHTML += `<option value="${executive}">${executive}</option>`;
                });
            });
        }

        // Load all token data
        async function loadData() {
            showLoading(true);
            try {
                const response = await fetch('/api/tokens');
                allTokens = await response.json();
                filteredTokens = [...allTokens];
                displayData(allTokens);
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error loading data', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Display data in the table
        function displayData(tokens) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            tokens.forEach(token => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${token.id}</td>
                    <td>${token.date || ''}</td>
                    <td>${token.location || ''}</td>
                    <td>${token.token || ''}</td>
                    <td>${token.client_name || ''}</td>
                    <td>
                        <span class="badge ${token.status === 'Completed' ? 'bg-success' : 'bg-warning'}">
                            ${token.status || 'Not Completed'}
                        </span>
                    </td>
                    <td>₹${token.charges || '0'}</td>
                    <td>₹${token.amount_due || '0'}</td>
                    <td>${token.agent_name || ''}</td>
                    <td>${token.executive_name || ''}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editToken(${token.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteToken(${token.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter data based on search and filters
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredTokens = allTokens.filter(token => {
                const matchesSearch = !searchTerm || 
                    (token.token && token.token.toLowerCase().includes(searchTerm)) ||
                    (token.client_name && token.client_name.toLowerCase().includes(searchTerm)) ||
                    (token.contact && token.contact.toLowerCase().includes(searchTerm)) ||
                    (token.sub_location && token.sub_location.toLowerCase().includes(searchTerm));

                const matchesLocation = !locationFilter || token.location === locationFilter;
                const matchesStatus = !statusFilter || token.status === statusFilter;

                return matchesSearch && matchesLocation && matchesStatus;
            });

            displayData(filteredTokens);
        }

        // Calculate amount due and margin
        function calculateAmounts() {
            const charges = parseFloat(document.getElementById('charges').value) || 0;
            const paymentReceived = parseFloat(document.getElementById('paymentReceived').value) || 0;
            const chargesToExecutive = parseFloat(document.getElementById('chargesToExecutive').value) || 0;

            document.getElementById('amountDue').value = (charges - paymentReceived).toFixed(2);
            document.getElementById('margin').value = (charges - chargesToExecutive).toFixed(2);
        }

        // Update sub-location field label based on location
        function updateSubLocationField() {
            const location = document.getElementById('location').value;
            const label = document.getElementById('subLocationLabel');
            const input = document.getElementById('subLocation');
            
            if (location === 'India') {
                label.textContent = 'City';
                input.placeholder = 'Enter city...';
            } else {
                label.textContent = 'Country and City';
                input.placeholder = 'Enter country and city...';
            }
        }

        // Handle form submission
        document.getElementById('tokenForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tokenId = document.getElementById('tokenId').value;
            const isEdit = !!tokenId;
            
            const formData = {
                date: formatDateForStorage(document.getElementById('date').value),
                location: document.getElementById('location').value,
                sub_location: document.getElementById('subLocation').value,
                token: document.getElementById('token').value,
                password: document.getElementById('password').value,
                client_name: document.getElementById('clientName').value,
                contact: document.getElementById('contact').value,
                who_will_ship: document.getElementById('whoWillShip').value,
                contacted_client: document.getElementById('contactedClient').value,
                status: document.getElementById('status').value,
                forwarded: document.getElementById('forwarded').value,
                charges: document.getElementById('charges').value,
                payment_received: document.getElementById('paymentReceived').value,
                charges_to_executive: document.getElementById('chargesToExecutive').value,
                agent_name: document.getElementById('agentName').value,
                executive_name: document.getElementById('executiveName').value,
                process_by: document.getElementById('processBy').value,
                completion_date: formatDateForStorage(document.getElementById('completionDate').value)
            };

            try {
                const url = isEdit ? `/api/tokens/${tokenId}` : '/api/tokens';
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showAlert(`Token ${isEdit ? 'updated' : 'added'} successfully!`, 'success');
                    resetForm();
                    loadData();
                    loadAgentsAndExecutives(); // Refresh dropdowns
                } else {
                    showAlert(`Error ${isEdit ? 'updating' : 'adding'} token`, 'danger');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showAlert('Error submitting form', 'danger');
            }
        });

        // Format date for storage (convert from YYYY-MM-DD to DD-MM-YYYY)
        function formatDateForStorage(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}-${month}-${year}`;
        }

        // Format date for display (convert from DD-MM-YYYY to YYYY-MM-DD)
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const [day, month, year] = dateString.split('-');
            return `${year}-${month}-${day}`;
        }

        // Reset form
        function resetForm() {
            document.getElementById('tokenForm').reset();
            document.getElementById('tokenId').value = '';
            document.getElementById('submitBtnText').textContent = 'Add Token';
            setDefaultDates();
            calculateAmounts();
        }

        // Edit token
        async function editToken(id) {
            try {
                const token = allTokens.find(t => t.id === id);
                if (!token) return;

                // Populate form with token data
                document.getElementById('tokenId').value = token.id;
                document.getElementById('date').value = formatDateForDisplay(token.date);
                document.getElementById('location').value = token.location || 'India';
                document.getElementById('subLocation').value = token.sub_location || '';
                document.getElementById('token').value = token.token || '';
                document.getElementById('password').value = token.password || '';
                document.getElementById('clientName').value = token.client_name || '';
                document.getElementById('contact').value = token.contact || '';
                document.getElementById('whoWillShip').value = token.who_will_ship || '';
                document.getElementById('contactedClient').value = token.contacted_client || 'Contacted client';
                document.getElementById('status').value = token.status || 'Not Completed';
                document.getElementById('forwarded').value = token.forwarded || 'Not Done';
                document.getElementById('charges').value = token.charges || '';
                document.getElementById('paymentReceived').value = token.payment_received || '';
                document.getElementById('chargesToExecutive').value = token.charges_to_executive || '';
                document.getElementById('agentName').value = token.agent_name || '';
                document.getElementById('executiveName').value = token.executive_name || 'Ramnath';
                document.getElementById('processBy').value = token.process_by || 'Doorstep';
                document.getElementById('completionDate').value = formatDateForDisplay(token.completion_date);

                document.getElementById('submitBtnText').textContent = 'Update Token';
                updateSubLocationField();
                calculateAmounts();

                // Scroll to form
                document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error editing token:', error);
                showAlert('Error loading token for editing', 'danger');
            }
        }

        // Delete token
        async function deleteToken(id) {
            if (!confirm('Are you sure you want to delete this token?')) return;

            try {
                const response = await fetch(`/api/tokens/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Token deleted successfully!', 'success');
                    loadData();
                } else {
                    showAlert('Error deleting token', 'danger');
                }
            } catch (error) {
                console.error('Error deleting token:', error);
                showAlert('Error deleting token', 'danger');
            }
        }

        // Generate agent report
        async function generateAgentReport() {
            const agent = document.getElementById('reportAgent').value;
            const status = document.getElementById('reportAgentStatus').value;
            const fromDate = document.getElementById('reportAgentFromDate').value;
            const toDate = document.getElementById('reportAgentToDate').value;

            if (!agent) {
                showAlert('Please select an agent', 'warning');
                return;
            }

            try {
                const params = new URLSearchParams({
                    agent: agent,
                    status: status,
                    from_date: fromDate,
                    to_date: toDate
                });

                const response = await fetch(`/api/reports/agent?${params}`);
                const data = await response.json();

                displayAgentReport(data);
            } catch (error) {
                console.error('Error generating agent report:', error);
                showAlert('Error generating agent report', 'danger');
            }
        }

        // Display agent report
        function displayAgentReport(tokens) {
            const tbody = document.getElementById('agentReportBody');
            tbody.innerHTML = '';

            tokens.forEach(token => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="agent-checkbox" value="${token.id}"></td>
                    <td>${token.date || ''}</td>
                    <td>${token.completion_date || ''}</td>
                    <td>${token.location || ''}</td>
                    <td>${token.token || ''}</td>
                    <td>${token.client_name || ''}</td>
                    <td>₹${token.charges || '0'}</td>
                    <td>₹${token.amount_due || '0'}</td>
                    <td>
                        <span class="badge ${token.status === 'Completed' ? 'bg-success' : 'bg-warning'}">
                            ${token.status || 'Not Completed'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${token.agent_payment_applied === 'yes' ? 'bg-success' : 'bg-secondary'}">
                            ${token.agent_payment_applied === 'yes' ? 'Applied' : 'Not Applied'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Generate executive report
        async function generateExecutiveReport() {
            const executive = document.getElementById('reportExecutive').value;
            const status = document.getElementById('reportExecutiveStatus').value;
            const fromDate = document.getElementById('reportExecutiveFromDate').value;
            const toDate = document.getElementById('reportExecutiveToDate').value;

            if (!executive) {
                showAlert('Please select an executive', 'warning');
                return;
            }

            try {
                const params = new URLSearchParams({
                    executive: executive,
                    status: status,
                    from_date: fromDate,
                    to_date: toDate
                });

                const response = await fetch(`/api/reports/executive?${params}`);
                const data = await response.json();

                displayExecutiveReport(data);
            } catch (error) {
                console.error('Error generating executive report:', error);
                showAlert('Error generating executive report', 'danger');
            }
        }

        // Display executive report
        function displayExecutiveReport(tokens) {
            const tbody = document.getElementById('executiveReportBody');
            tbody.innerHTML = '';

            tokens.forEach(token => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="executive-checkbox" value="${token.id}"></td>
                    <td>${token.date || ''}</td>
                    <td>${token.completion_date || ''}</td>
                    <td>${token.location || ''}</td>
                    <td>${token.token || ''}</td>
                    <td>${token.client_name || ''}</td>
                    <td>₹${token.charges_to_executive || '0'}</td>
                    <td>₹${token.margin || '0'}</td>
                    <td>
                        <span class="badge ${token.status === 'Completed' ? 'bg-success' : 'bg-warning'}">
                            ${token.status || 'Not Completed'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${token.executive_payment_applied === 'yes' ? 'bg-success' : 'bg-secondary'}">
                            ${token.executive_payment_applied === 'yes' ? 'Applied' : 'Not Applied'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Generate profit report
        async function generateProfitReport() {
            const agent = document.getElementById('profitAgent').value;
            const location = document.getElementById('profitLocation').value;
            const status = document.getElementById('profitStatus').value;
            const fromDate = document.getElementById('profitFromDate').value;
            const toDate = document.getElementById('profitToDate').value;

            try {
                const params = new URLSearchParams({
                    agent: agent,
                    location: location,
                    status: status,
                    from_date: fromDate,
                    to_date: toDate
                });

                const response = await fetch(`/api/tokens?${params}`);
                const data = await response.json();

                displayProfitReport(data);
                updateProfitSummary(data);
            } catch (error) {
                console.error('Error generating profit report:', error);
                showAlert('Error generating profit report', 'danger');
            }
        }

        // Display profit report
        function displayProfitReport(tokens) {
            const tbody = document.getElementById('profitTableBody');
            tbody.innerHTML = '';

            tokens.forEach(token => {
                const charges = parseFloat(token.charges) || 0;
                const executiveCharges = parseFloat(token.charges_to_executive) || 0;
                const profit = charges - executiveCharges;
                const marginPercent = charges > 0 ? ((profit / charges) * 100).toFixed(2) : 0;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${token.date || ''}</td>
                    <td>${token.token || ''}</td>
                    <td>${token.location || ''}</td>
                    <td>${token.agent_name || ''}</td>
                    <td>₹${charges.toFixed(2)}</td>
                    <td>₹${executiveCharges.toFixed(2)}</td>
                    <td>₹${profit.toFixed(2)}</td>
                    <td>${marginPercent}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update profit summary cards
        function updateProfitSummary(tokens) {
            let totalProfit = 0;
            let totalRevenue = 0;
            let totalTokens = tokens.length;

            tokens.forEach(token => {
                const charges = parseFloat(token.charges) || 0;
                const executiveCharges = parseFloat(token.charges_to_executive) || 0;
                
                totalRevenue += charges;
                totalProfit += (charges - executiveCharges);
            });

            const avgProfit = totalTokens > 0 ? (totalProfit / totalTokens) : 0;

            document.getElementById('totalProfit').textContent = `₹${totalProfit.toFixed(2)}`;
            document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toFixed(2)}`;
            document.getElementById('totalTokens').textContent = totalTokens;
            document.getElementById('avgProfit').textContent = `₹${avgProfit.toFixed(2)}`;
        }

        // Bulk operations
        async function bulkApplyAgentPayment() {
            const checkboxes = document.querySelectorAll('.agent-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (ids.length === 0) {
                showAlert('Please select at least one record', 'warning');
                return;
            }

            if (!confirm(`Apply payment to ${ids.length} selected records?`)) return;

            try {
                const response = await fetch('/api/bulk-operations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'apply_agent_payment',
                        ids: ids
                    })
                });

                if (response.ok) {
                    showAlert('Agent payments applied successfully!', 'success');
                    generateAgentReport();
                } else {
                    showAlert('Error applying payments', 'danger');
                }
            } catch (error) {
                console.error('Error applying bulk payments:', error);
                showAlert('Error applying payments', 'danger');
            }
        }

        async function bulkApplyExecutivePayment() {
            const checkboxes = document.querySelectorAll('.executive-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (ids.length === 0) {
                showAlert('Please select at least one record', 'warning');
                return;
            }

            if (!confirm(`Apply payment to ${ids.length} selected records?`)) return;

            try {
                const response = await fetch('/api/bulk-operations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'apply_executive_payment',
                        ids: ids
                    })
                });

                if (response.ok) {
                    showAlert('Executive payments applied successfully!', 'success');
                    generateExecutiveReport();
                } else {
                    showAlert('Error applying payments', 'danger');
                }
            } catch (error) {
                console.error('Error applying bulk payments:', error);
                showAlert('Error applying payments', 'danger');
            }
        }

        // Mark all completed
        async function markAllCompleted(type) {
            const checkboxes = document.querySelectorAll(`.${type}-checkbox:checked`);
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (ids.length === 0) {
                showAlert('Please select at least one record', 'warning');
                return;
            }

            if (!confirm(`Mark ${ids.length} selected records as completed?`)) return;

            try {
                const response = await fetch('/api/bulk-operations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'mark_completed',
                        ids: ids
                    })
                });

                if (response.ok) {
                    showAlert('Records marked as completed!', 'success');
                    if (type === 'agent') {
                        generateAgentReport();
                    } else {
                        generateExecutiveReport();
                    }
                } else {
                    showAlert('Error updating records', 'danger');
                }
            } catch (error) {
                console.error('Error marking completed:', error);
                showAlert('Error updating records', 'danger');
            }
        }

        // Toggle select all
        function toggleSelectAll(type) {
            const selectAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const checkboxes = document.querySelectorAll(`.${type}-checkbox`);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // Export functions
        async function exportData() {
            try {
                const response = await fetch('/api/export');
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `tokens_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('Data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('Error exporting data', 'danger');
            }
        }

        // Utility functions
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('d-none');
            } else {
                spinner.classList.add('d-none');
            }
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer') || createAlertContainer();
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alert);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function createAlertContainer() {
            const container = document.createElement('div');
            container.id = 'alertContainer';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            container.style.maxWidth = '400px';
            document.body.appendChild(container);
            return container;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function refreshData() {
            loadData();
            showAlert('Data refreshed successfully!', 'success');
        }

        function showAbout() {
            const aboutContent = `
                <h5>Token Management System</h5>
                <p><strong>Cloud-based version of the desktop application</strong></p>
                <hr>
                <h6>Key Features:</h6>
                <ul>
                    <li>Add, edit, and manage token records</li>
                    <li>Advanced filtering and search capabilities</li>
                    <li>Agent and executive payment reports</li>
                    <li>Profit analysis and reporting</li>
                    <li>Bulk operations for efficient processing</li>
                    <li>CSV export functionality</li>
                </ul>
                <hr>
                <p><strong>Created by:</strong> Nitya Technologies, Mumbai</p>
                <p><strong>Founded by:</strong> Mr. Anagh (IIT Kharagpur alumnus)</p>
                <p><strong>Contact:</strong> anagh.iitkgp@hotmail.com</p>
                <p><em>Response within 24 hours</em></p>
            `;
            
            showAlert(aboutContent, 'info');
        }
    </script>
</body>
</html>
                