<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2980b9;
            --secondary-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Roboto', sans-serif;
            color: var(--dark-text);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(41, 128, 185, 0.25);
        }

        .nav-pills .nav-link.active {
            background: var(--primary-color);
            border-radius: 25px;
        }

        .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .nav-pills .nav-link:hover {
            background: rgba(41, 128, 185, 0.1);
        }

        .alert {
            border: none;
            border-radius: 10px;
        }

        .spinner-border {
            color: var(--primary-color);
        }

        .modal-content {
            border-radius: 15px;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .settings-section {
            margin-bottom: 1rem;
        }

        .settings-section .card {
            margin-bottom: 1rem;
        }

        .backup-status {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .backup-status.success {
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--secondary-color);
        }

        .backup-status.pending {
            background-color: rgba(241, 196, 15, 0.1);
            border-left: 4px solid var(--warning-color);
        }

        .backup-status.failed {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--danger-color);
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-badge {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .sensitive-data {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            position: relative;
        }

        .sensitive-data::before {
            content: "Restricted";
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 0 8px 0 8px;
        }

        .role-badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.35rem;
        }

        .role-admin {
            color: #fff;
            background-color: var(--danger-color);
        }

        .role-user {
            color: #fff;
            background-color: var(--primary-color);
        }

        .role-agent {
            color: #fff;
            background-color: var(--info-color);
        }

        .role-executive {
            color: #fff;
            background-color: var(--warning-color);
        }

        @media (max-width: 768px) {
            .card {
                margin-bottom: 1rem;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="card login-card">
            <div class="card-header text-center">
                <h4><i class="fas fa-coins me-2"></i>Token Management System</h4>
                <p class="mb-0">Please login to continue</p>
            </div>
            <div class="card-body">
                <div id="loginAlert"></div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">Default: admin/admin123, user/user123, agent/agent123, executive/executive123</small>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden until login) -->
    <div id="mainApp" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-coins me-2"></i>
                    Token Management System
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="exportData()">
                                <i class="fas fa-download me-1"></i>Export
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showAbout()">
                                <i class="fas fa-info-circle me-1"></i>About
                            </a>
                        </li>
                    </ul>
                    <div class="user-info text-white">
                        <i class="fas fa-user-circle"></i>
                        <span id="currentUser">Admin</span>
                        <span id="userRole" class="user-badge">Admin</span>
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid mt-4">
            <!-- Tab Navigation -->
            <ul class="nav nav-pills mb-4 justify-content-center" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="data-tab" data-bs-toggle="pill" data-bs-target="#data-content" type="button">
                        <i class="fas fa-database me-2"></i>Data Management
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="filter-tab" data-bs-toggle="pill" data-bs-target="#filter-content" type="button">
                        <i class="fas fa-filter me-2"></i>Token Filter
                    </button>
                </li>
                <li class="nav-item admin-only user-only agent-only" role="presentation" style="display: none;">
                    <button class="nav-link" id="agent-tab" data-bs-toggle="pill" data-bs-target="#agent-content" type="button">
                        <i class="fas fa-user-tie me-2"></i>Agent Reports
                    </button>
                </li>
                <li class="nav-item admin-only executive-only" role="presentation" style="display: none;">
                    <button class="nav-link" id="executive-tab" data-bs-toggle="pill" data-bs-target="#executive-content" type="button">
                        <i class="fas fa-user-shield me-2"></i>Executive Reports
                    </button>
                </li>
                <li class="nav-item admin-only" role="presentation" style="display: none;">
                    <button class="nav-link" id="profit-tab" data-bs-toggle="pill" data-bs-target="#profit-content" type="button">
                        <i class="fas fa-chart-line me-2"></i>Profit Analysis
                    </button>
                </li>
                <li class="nav-item admin-only" role="presentation" style="display: none;">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="pill" data-bs-target="#settings-content" type="button">
                        <i class="fas fa-cog me-2"></i>Settings
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabContent">
                <!-- Data Management Tab -->
                <div class="tab-pane fade show active" id="data-content">
                    <div class="row">
                        <!-- Add/Edit Form -->
                        <div class="col-12 col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add New Token</h5>
                                </div>
                                <div class="card-body">
                                    <form id="tokenForm">
                                        <input type="hidden" id="tokenId">
                                        
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="form-label">Date</label>
                                                <input type="date" class="form-control" id="date" required>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Completion Date</label>
                                                <input type="date" class="form-control" id="completionDate">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="form-label">Location</label>
                                                <select class="form-select" id="location" onchange="updateSubLocationField()">
                                                    <option value="India">India</option>
                                                    <option value="International">International</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label" id="subLocationLabel">City</label>
                                                <!-- City Input Field -->
                                                <input type="text" class="form-control" id="subLocation" placeholder="Enter city...">
                                                <!-- Country Dropdown (Hidden by default) -->
                                                <select class="form-select" id="countrySelect" style="display: none;">
                                                    <option value="">Select Country</option>
                                                    <option value="USA">United States</option>
                                                    <option value="UK">United Kingdom</option>
                                                    <option value="Canada">Canada</option>
                                                    <option value="Australia">Australia</option>
                                                    <option value="Germany">Germany</option>
                                                    <option value="France">France</option>
                                                    <option value="Japan">Japan</option>
                                                    <option value="China">China</option>
                                                    <option value="Singapore">Singapore</option>
                                                    <option value="UAE">United Arab Emirates</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Token</label>
                                            <input type="text" class="form-control" id="token" required>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Password</label>
                                            <input type="text" class="form-control" id="password">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Client Name</label>
                                            <input type="text" class="form-control" id="clientName" required>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Contact</label>
                                            <input type="text" class="form-control" id="contact">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Who Will Ship</label>
                                            <input type="text" class="form-control" id="whoWillShip">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Client Status</label>
                                            <select class="form-select" id="contactedClient">
                                                <option value="Contacted client">Contacted client</option>
                                                <option value="Biometric Completed">Biometric Completed</option>
                                                <option value="Visited but server down">Visited but server down</option>
                                                <option value="Delivered">Delivered</option>
                                                <option value="Pickup booked">Pickup booked</option>
                                                <option value="Device shipped">Device shipped</option>
                                                <option value="Forwaded to executive">Forwaded to executive</option>
                                                <option value="Client replied">Client replied</option>
                                                <option value="Not msg clnt">Not msg clnt</option>
                                                <option value="Client NR">Client NR</option>
                                                <option value="Asked pcts">Asked pcts</option>
                                                <option value="Laptop not available">Laptop not available</option>
                                                <option value="Failed">Failed</option>
                                                <option value="Lost">Lost</option>
                                            </select>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="form-label">Status</label>
                                                <select class="form-select" id="status">
                                                    <option value="Not Completed">Not Completed</option>
                                                    <option value="Completed">Completed</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Forwarded</label>
                                                <select class="form-select" id="forwarded">
                                                    <option value="Not Done">Not Done</option>
                                                    <option value="Done">Done</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row mb-3 admin-only-field user-only-field" style="display: none;">
                                            <div class="col-6">
                                                <label class="form-label">Charges</label>
                                                <input type="number" class="form-control" id="charges" step="0.01" onchange="calculateAmounts()">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Payment Received</label>
                                                <input type="number" class="form-control" id="paymentReceived" step="0.01" onchange="calculateAmounts()">
                                            </div>
                                        </div>

                                        <div class="row mb-3 admin-only-field user-only-field" style="display: none;">
                                            <div class="col-6">
                                                <label class="form-label">Amount Due</label>
                                                <input type="number" class="form-control" id="amountDue" readonly>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Executive Charges</label>
                                                <input type="number" class="form-control" id="chargesToExecutive" step="0.01" onchange="calculateAmounts()">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <label class="form-label">Agent Name</label>
                                                <input type="text" class="form-control" id="agentName">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Executive Name</label>
                                                <input type="text" class="form-control" id="executiveName" value="Ramnath">
                                            </div>
                                        </div>

                                        <div class="row mb-3 admin-only-field user-only-field" style="display: none;">
                                            <div class="col-6">
                                                <label class="form-label">Margin</label>
                                                <input type="number" class="form-control" id="margin" readonly>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Process By</label>
                                                <select class="form-select" id="processBy">
                                                    <option value="Doorstep">Doorstep</option>
                                                    <option value="Centre Visit">Centre Visit</option>
                                                    <option value="Device">Device</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i><span id="submitBtnText">Add Token</span>
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                                <i class="fas fa-undo me-2"></i>Reset Form
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Data Table -->
                        <div class="col-12 col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Token Data</h5>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-light btn-sm" onclick="refreshData()">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-light btn-sm admin-only user-only" style="display: none;" onclick="exportData()">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Search and Filters -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                <input type="text" class="form-control" id="searchInput" placeholder="Search tokens...">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="locationFilter" onchange="filterData()">
                                                <option value="">All Locations</option>
                                                <option value="India">India</option>
                                                <option value="International">International</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="statusFilter" onchange="filterData()">
                                                <option value="">All Status</option>
                                                <option value="Completed">Completed</option>
                                                <option value="Not Completed">Not Completed</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Loading Spinner -->
                                    <div id="loadingSpinner" class="text-center d-none">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>

                                    <!-- Data Table -->
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Date</th>
                                                    <th>Location</th>
                                                    <th>Token</th>
                                                    <th>Client Name</th>
                                                    <th>Status</th>
                                                    <th class="admin-only-column user-only-column" style="display: none;">Charges</th>
                                                    <th class="admin-only-column user-only-column agent-only-column" style="display: none;">Amount Due</th>
                                                    <th>Agent</th>
                                                    <th>Executive</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="dataTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Token Filter Tab -->
                <div class="tab-pane fade" id="filter-content">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Advanced Token Filtering</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-2">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="filterStatus">
                                        <option value="">All</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Not Completed">Not Completed</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Location</label>
                                    <select class="form-select" id="filterLocation" onchange="updateFilterLocationField()">
                                        <option value="">All</option>
                                        <option value="India">India</option>
                                        <option value="International">International</option>
                                    </select>
                                </div>
                                <div class="col-md-2" id="countryFilterDiv" style="display: none;">
                                    <label class="form-label">Country</label>
                                    <select class="form-select" id="filterCountry">
                                        <option value="">All Countries</option>
                                        <option value="USA">United States</option>
                                        <option value="UK">United Kingdom</option>
                                        <option value="Canada">Canada</option>
                                        <option value="Australia">Australia</option>
                                        <option value="Germany">Germany</option>
                                        <option value="France">France</option>
                                        <option value="Japan">Japan</option>
                                        <option value="China">China</option>
                                        <option value="Singapore">Singapore</option>
                                        <option value="UAE">United Arab Emirates</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="filterFromDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="filterToDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Agent</label>
                                    <select class="form-select" id="filterAgent">
                                        <option value="">All Agents</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <button class="btn btn-primary me-2" onclick="applyFilters()">
                                        <i class="fas fa-filter me-1"></i>Apply Filters
                                    </button>
                                    <button class="btn btn-secondary me-2" onclick="clearFilters()">
                                        <i class="fas fa-times me-1"></i>Clear Filters
                                    </button>
                                    <button class="btn btn-success admin-only user-only" style="display: none;" onclick="exportFilteredData()">
                                        <i class="fas fa-download me-1"></i>Export Results
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped" id="filteredTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Date</th>
                                            <th>Location</th>
                                            <th>City/Country</th>
                                            <th>Token</th>
                                            <th>Client Name</th>
                                            <th>Status</th>
                                            <th class="admin-only-column user-only-column" style="display: none;">Charges</th>
                                            <th class="admin-only-column user-only-column agent-only-column" style="display: none;">Amount Due</th>
                                            <th>Agent</th>
                                            <th>Executive</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="filteredTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agent Reports Tab -->
                <div class="tab-pane fade admin-only user-only agent-only" id="agent-content">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Agent Reports</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <label class="form-label">Agent</label>
                                    <select class="form-select" id="reportAgent" required>
                                        <option value="">Select Agent</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="reportAgentStatus">
                                        <option value="All">All</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Incomplete">Incomplete</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="reportAgentFromDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="reportAgentToDate">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button class="btn btn-primary" onclick="generateAgentReport()">
                                            <i class="fas fa-chart-bar me-1"></i>Generate Report
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-success admin-only user-only" style="display: none;" onclick="bulkApplyAgentPayment()">
                                            <i class="fas fa-money-check-alt me-1"></i>Apply Payment (All)
                                        </button>
                                        <button class="btn btn-info" onclick="markAllCompleted('agent')">
                                            <i class="fas fa-check-circle me-1"></i>Mark All Completed
                                        </button>
                                        <button class="btn btn-warning admin-only user-only" style="display: none;" onclick="exportAgentReport()">
                                            <i class="fas fa-file-export me-1"></i>Export Report
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped" id="agentReportTable">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="selectAllAgent" onchange="toggleSelectAll('agent')"></th>
                                            <th>Date</th>
                                            <th>Completion Date</th>
                                            <th>Location</th>
                                            <th>Token</th>
                                            <th>Client Name</th>
                                            <th class="admin-only-column user-only-column" style="display: none;">Charges</th>
                                            <th class="admin-only-column user-only-column agent-only-column" style="display: none;">Amount Due</th>
                                            <th>Status</th>
                                            <th class="admin-only-column user-only-column" style="display: none;">Payment Applied</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agentReportBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Executive Reports Tab -->
                <div class="tab-pane fade admin-only executive-only" id="executive-content">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Executive Reports</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <label class="form-label">Executive</label>
                                    <select class="form-select" id="reportExecutive" required>
                                        <option value="">Select Executive</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="reportExecutiveStatus">
                                        <option value="All">All</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Incomplete">Incomplete</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="reportExecutiveFromDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="reportExecutiveToDate">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button class="btn btn-primary" onclick="generateExecutiveReport()">
                                            <i class="fas fa-chart-bar me-1"></i>Generate Report
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-success" onclick="bulkApplyExecutivePayment()">
                                            <i class="fas fa-money-check-alt me-1"></i>Apply Payment (All)
                                        </button>
                                        <button class="btn btn-info" onclick="markAllCompleted('executive')">
                                            <i class="fas fa-check-circle me-1"></i>Mark All Completed
                                        </button>
                                        <button class="btn btn-warning" onclick="exportExecutiveReport()">
                                            <i class="fas fa-file-export me-1"></i>Export Report
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped" id="executiveReportTable">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="selectAllExecutive" onchange="toggleSelectAll('executive')"></th>
                                            <th>Date</th>
                                            <th>Completion Date</th>
                                            <th>Location</th>
                                            <th>Token</th>
                                            <th>Client Name</th>
                                            <th class="admin-only-column executive-only-column" style="display: none;">Executive Charges</th>
                                            <th class="admin-only-column" style="display: none;">Margin</th>
                                            <th>Status</th>
                                            <th>Payment Applied</th>
                                        </tr>
                                    </thead>
                                    <tbody id="executiveReportBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profit Analysis Tab -->
                <div class="tab-pane fade admin-only" id="profit-content">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Profit Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <label class="form-label">Agent</label>
                                    <select class="form-select" id="profitAgent">
                                        <option value="All">All Agents</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Location</label>
                                    <select class="form-select" id="profitLocation">
                                        <option value="All">All</option>
                                        <option value="India">India</option>
                                        <option value="International">International</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="profitStatus">
                                        <option value="All">All</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Not Completed">Not Completed</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="profitFromDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="profitToDate">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button class="btn btn-primary" onclick="generateProfitReport()">
                                            <i class="fas fa-search me-1"></i>Analyze
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Profit Summary Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <h4 id="totalProfit">₹0</h4>
                                            <p class="mb-0">Total Profit</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <h4 id="totalRevenue">₹0</h4>
                                            <p class="mb-0">Total Revenue</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <h4 id="totalTokens">0</h4>
                                            <p class="mb-0">Total Tokens</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body text-center">
                                            <h4 id="avgProfit">₹0</h4>
                                            <p class="mb-0">Avg Profit/Token</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped" id="profitTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Token</th>
                                            <th>Location</th>
                                            <th>Agent</th>
                                            <th>Revenue</th>
                                            <th>Executive Charges</th>
                                            <th>Profit</th>
                                            <th>Margin %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="profitTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade admin-only" id="settings-content">
                    <div class="settings-section">
                        <!-- User Management -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-users me-2"></i>User Management</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="newUsername" placeholder="Enter username">
                                            <input type="password" class="form-control" id="newPassword" placeholder="Enter password">
                                            <select class="form-select" id="newUserRole">
                                                <option value="user">User</option>
                                                <option value="admin">Admin</option>
                                                <option value="agent">Agent</option>
                                                <option value="executive">Executive</option>
                                            </select>
                                            <button class="btn btn-primary" onclick="addUser()">
                                                <i class="fas fa-plus"></i> Add User
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped" id="usersTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Username</th>
                                                <th>Role</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Countries Management -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-globe me-2"></i>Manage Countries</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="newCountryName" placeholder="Enter country name">
                                                    <button class="btn btn-primary" onclick="addCountry()">
                                                        <i class="fas fa-plus"></i> Add Country
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-striped" id="countriesTable">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Country Name</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="countriesTableBody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Agents Management -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Manage Agents</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="newAgentName" placeholder="Enter agent name">
                                                    <button class="btn btn-primary" onclick="addAgent()">
                                                        <i class="fas fa-plus"></i> Add Agent
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-striped" id="agentsTable">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Agent Name</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="agentsTableBody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Cleaning -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-broom me-2"></i>Clean Data</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <p>Use these tools to clean up your data and fix common issues:</p>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button class="btn btn-warning" onclick="removeDuplicateTokens()">
                                                <i class="fas fa-copy me-1"></i>Remove Duplicate Tokens
                                            </button>
                                            <button class="btn btn-warning" onclick="fixAgentNames()">
                                                <i class="fas fa-user-edit me-1"></i>Fix Agent Names
                                            </button>
                                            <button class="btn btn-warning" onclick="fixClientNames()">
                                                <i class="fas fa-user-friends me-1"></i>Fix Client Names
                                            </button>
                                            <button class="btn btn-warning" onclick="removeEmptyFields()">
                                                <i class="fas fa-eraser me-1"></i>Remove Empty Fields
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Database Backup -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-database me-2"></i>Database Backup</h5>
                            </div>
                            <div class="card-body">
                                <div class="backup-status" id="backupStatus">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Last Backup:</strong> <span id="lastBackupTime">Never</span>
                                        </div>
                                        <div>
                                            <strong>Next Backup:</strong> <span id="nextBackupTime">Calculating...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="autoBackupToggle" checked>
                                            <label class="form-check-label" for="autoBackupToggle">
                                                Enable Auto Backup (Every 6 hours)
                                            </label>
                                        </div>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button class="btn btn-success" onclick="backupDatabase()">
                                                <i class="fas fa-download me-1"></i>Backup Now
                                            </button>
                                            <button class="btn btn-info" onclick="downloadDatabase()">
                                                <i class="fas fa-file-download me-1"></i>Download Database
                                            </button>
                                            <button class="btn btn-secondary" onclick="restoreDatabase()">
                                                <i class="fas fa-upload me-1"></i>Restore Database
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Country Modal -->
    <div class="modal fade" id="editCountryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Country</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editCountryId">
                    <div class="mb-3">
                        <label class="form-label">Country Name</label>
                        <input type="text" class="form-control" id="editCountryName">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCountry()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Agent Modal -->
    <div class="modal fade" id="editAgentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Agent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editAgentId">
                    <div class="mb-3">
                        <label class="form-label">Agent Name</label>
                        <input type="text" class="form-control" id="editAgentName">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAgent()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="editPassword" placeholder="Leave blank to keep current password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="editUserRole">
                            <option value="Admin">Admin</option>
                            <option value="User">User</option>
                            <option value="Agent">Agent</option>
                            <option value="Executive">Executive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedUser()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Configuration for API connection
        let apiConfig = {
            endpoint: 'https://your-api-endpoint.com/api',
            database: 'token_management',
            apiKey: ''
        };

        // User management data
        let users = [
            { id: 1, username: 'admin', password: 'admin123', role: 'Admin', status: 'Active' },
            { id: 2, username: 'user', password: 'user123', role: 'User', status: 'Active' },
            { id: 3, username: 'agent', password: 'agent123', role: 'Agent', status: 'Active' },
            { id: 4, username: 'executive', password: 'executive123', role: 'Executive', status: 'Active' }
        ];

        // Cache for token data (used for reports/exports)
        let tokenDataCache = [];
        const TOKENS_STORAGE_KEY = 'tokens';
        const BACKUP_STORAGE_KEY = 'tms_backup';
        const BACKUP_LAST_TIME = 'tms_backup_time';
        const AUTO_BACKUP_ENABLED = 'tms_auto_backup_enabled';
        const AUTO_BACKUP_NEXT = 'tms_auto_backup_next';
        const AUTO_BACKUP_INTERVAL_MS = 6 * 60 * 60 * 1000; // 6 hours

        // Helpers for tokens storage and UI refresh
        function getLocalTokens() {
            try {
                const raw = localStorage.getItem(TOKENS_STORAGE_KEY);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch { return []; }
        }

        // Determine if API is configured
        function isApiConfigured() {
            const ep = (apiConfig && apiConfig.endpoint || '').trim();
            if (!ep) return false;
            if (/your-api-endpoint\.com/i.test(ep)) return false; // placeholder
            return /^https?:\/\//i.test(ep) || ep.startsWith('/');
        }
        function setLocalTokens(tokens) {
            localStorage.setItem(TOKENS_STORAGE_KEY, JSON.stringify(tokens || []));
            tokenDataCache = tokens || [];
        }
        function refreshTokensTableFromCache() {
            const tableBody = document.getElementById('dataTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            (tokenDataCache || []).forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${formatDate(item.date)}</td>
                    <td>${item.location || ''}</td>
                    <td>${item.token || ''}</td>
                    <td>${item.client_name || ''}</td>
                    <td>${item.status || ''}</td>
                    <td class="admin-only-column user-only-column" style="display: none;">${item.charges || 0}</td>
                    <td class="admin-only-column user-only-column agent-only-column" style="display: none;">${item.amount_due || 0}</td>
                    <td>${item.agent_name || ''}</td>
                    <td>${item.executive_name || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editToken(${item.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteToken(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Backup helpers
        function updateBackupUI() {
            const lastEl = document.getElementById('lastBackupTime');
            const nextEl = document.getElementById('nextBackupTime');
            const last = localStorage.getItem(BACKUP_LAST_TIME);
            const next = localStorage.getItem(AUTO_BACKUP_NEXT);
            if (lastEl) lastEl.textContent = last ? new Date(parseInt(last,10)).toLocaleString() : 'Never';
            if (nextEl) nextEl.textContent = next ? new Date(parseInt(next,10)).toLocaleString() : 'Calculating...';
        }
        function scheduleNextBackup() {
            const next = Date.now() + AUTO_BACKUP_INTERVAL_MS;
            localStorage.setItem(AUTO_BACKUP_NEXT, String(next));
            updateBackupUI();
        }
        function initAutoBackup() {
            const toggle = document.getElementById('autoBackupToggle');
            if (toggle) {
                const enabled = localStorage.getItem(AUTO_BACKUP_ENABLED) !== 'false';
                toggle.checked = enabled;
                toggle.addEventListener('change', () => {
                    localStorage.setItem(AUTO_BACKUP_ENABLED, toggle.checked ? 'true' : 'false');
                    if (toggle.checked) scheduleNextBackup();
                });
            }
            updateBackupUI();
            // poll every minute to see if it's time to backup
            setInterval(() => {
                const enabled = localStorage.getItem(AUTO_BACKUP_ENABLED) !== 'false';
                if (!enabled) return;
                const nextRaw = localStorage.getItem(AUTO_BACKUP_NEXT);
                const due = nextRaw ? parseInt(nextRaw,10) : 0;
                if (Date.now() >= due) {
                    backupDatabase(true); // silent
                    scheduleNextBackup();
                }
            }, 60000);
        }

        // Load shared defaults from config.json, then override with localStorage if available
        (async function loadApiConfig() {
            try {
                const res = await fetch('config.json', { cache: 'no-store' });
                if (res.ok) {
                    const cfg = await res.json();
                    apiConfig = { ...apiConfig, ...cfg };
                }
            } catch (e) {
                // If running locally via file:// or config missing, just skip
                console.warn('Config load skipped:', e?.message || e);
            }
            const stored = localStorage.getItem('apiConfig');
            if (stored) {
                try { apiConfig = { ...apiConfig, ...JSON.parse(stored) }; } catch {}
            }
        })();

        // Load users from localStorage if available
        if (localStorage.getItem('users')) {
            users = JSON.parse(localStorage.getItem('users'));
        }

        // Helper function to format date to DD-MM-YYYY
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Helper function to parse date from DD-MM-YYYY
        function parseDate(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length !== 3) return '';
            const day = parts[0];
            const month = parts[1];
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }

        // Helper function to show API status messages
        function showApiStatus(message, isSuccess) {
            const statusElement = document.getElementById('apiStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = 'api-status ' + (isSuccess ? 'success' : 'error');
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            } else {
                // Show alert if no status element
                alert(message);
            }
        }

        // API functions for database operations
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const url = `${apiConfig.endpoint}${endpoint}`;
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiConfig.apiKey
                    }
                };

                if (data && (method === 'POST' || method === 'PUT')) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API request error:', error);
                showApiStatus('API request failed: ' + error.message, false);
                throw error;
            }
        }

        // Login functionality
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const loginAlert = document.getElementById('loginAlert');
            
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                
                // Clear previous alerts
                loginAlert.innerHTML = '';
                
                // Validate credentials
                let isValid = false;
                let userRole = '';
                
                // Check against stored users
                const user = users.find(u => u.username === username && u.password === password && u.status === 'Active');
                
                if (user) {
                    isValid = true;
                    userRole = user.role;
                }
                
                if (isValid) {
                    // Hide login screen and show main app
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Set current user and role in the UI
                    document.getElementById('currentUser').textContent = username;
                    document.getElementById('userRole').textContent = userRole;
                    
                    // Apply role-based visibility
                    applyRoleBasedVisibility(userRole);
                    
                    // Load initial data
                    loadTokenData();
                    loadUsers();
                } else {
                    // Show error message
                    loginAlert.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>Invalid username or password!
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                }
            });

            // Populate settings fields if present
            const apiEndpointEl = document.getElementById('apiEndpoint');
            const dbNameEl = document.getElementById('dbName');
            const apiKeyEl = document.getElementById('apiKey');
            if (apiEndpointEl) apiEndpointEl.value = apiConfig.endpoint || '';
            if (dbNameEl) dbNameEl.value = apiConfig.database || '';
            if (apiKeyEl) apiKeyEl.value = apiConfig.apiKey || '';

            // Database settings form submission (guarded)
            const dbSettingsForm = document.getElementById('dbSettingsForm');
            if (dbSettingsForm) {
                dbSettingsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    apiConfig.endpoint = apiEndpointEl ? apiEndpointEl.value : apiConfig.endpoint;
                    apiConfig.database = dbNameEl ? dbNameEl.value : apiConfig.database;
                    apiConfig.apiKey = apiKeyEl ? apiKeyEl.value : apiConfig.apiKey;
                    localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
                    showApiStatus('Database connection settings saved successfully!', true);
                });
            }

            // Token form submission
            const tokenForm = document.getElementById('tokenForm');
            tokenForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveToken();
            });
        });

        // Initialize backup scheduler after DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            initAutoBackup();
        });
        
        // Function to apply role-based visibility
        function applyRoleBasedVisibility(role) {
            // Hide all role-specific elements first (sections, fields, and table columns)
            const hideSelectors = [
                '.admin-only', '.user-only', '.agent-only', '.executive-only',
                '.admin-only-field', '.user-only-field', '.agent-only-field', '.executive-only-field',
                '.admin-only-column', '.user-only-column', '.agent-only-column', '.executive-only-column'
            ];
            document.querySelectorAll(hideSelectors.join(','))
                .forEach(el => { el.style.display = 'none'; });

            // Helper to show a group of selectors
            const showGroup = (selectors) => {
                document.querySelectorAll(selectors.join(','))
                    .forEach(el => { el.style.display = ''; });
            };

            // Show elements based on role
            if (role === 'Admin') {
                showGroup(['.admin-only', '.admin-only-field', '.admin-only-column']);
            } else if (role === 'User') {
                showGroup(['.user-only', '.user-only-field', '.user-only-column']);
            } else if (role === 'Agent') {
                showGroup(['.agent-only', '.agent-only-field', '.agent-only-column']);
            } else if (role === 'Executive') {
                showGroup(['.executive-only', '.executive-only-field', '.executive-only-column']);
            }
        }
        
        // Function to load token data from the database
        async function loadTokenData() {
            // Show loading spinner
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.classList.remove('d-none');
            }
            
            // If API not configured, skip network and use local/sample silently
            if (!isApiConfigured()) {
                const localTokensRaw = localStorage.getItem(TOKENS_STORAGE_KEY);
                let fallbackData = [];
                if (localTokensRaw) { try { fallbackData = JSON.parse(localTokensRaw); } catch {} }
                if (!Array.isArray(fallbackData) || fallbackData.length === 0) {
                    fallbackData = [
                        { id: 1, date: '2023-05-15', location: 'India', subLocation: 'Mumbai', token: 'TKN001', client_name: 'John Doe', status: 'Completed', charges: 500, amount_due: 0, agent_name: 'Agent1', executive_name: 'Ramnath' },
                        { id: 2, date: '2023-05-16', location: 'International', subLocation: 'USA', token: 'TKN002', client_name: 'Jane Smith', status: 'Not Completed', charges: 750, amount_due: 750, agent_name: 'Agent2', executive_name: 'Ramnath' }
                    ];
                }
                tokenDataCache = fallbackData;
                refreshTokensTableFromCache();
                showApiStatus(Array.isArray(localTokensRaw) ? 'Using locally saved tokens.' : 'Using sample data. Configure API connection to use your database.', false);
                return;
            }
            try {
                // Fetch data from API
                const data = await apiRequest('/tokens');
                
                // Hide loading spinner
                if (loadingSpinner) {
                    loadingSpinner.classList.add('d-none');
                }
                
                // Cache and populate the table
                tokenDataCache = Array.isArray(data) ? data : [];
                const tableBody = document.getElementById('dataTableBody');
                tableBody.innerHTML = '';
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>${item.location}</td>
                        <td>${item.token}</td>
                        <td>${item.client_name}</td>
                        <td>${item.status}</td>
                        <td class="admin-only-column user-only-column" style="display: none;">${item.charges || 0}</td>
                        <td class="admin-only-column user-only-column agent-only-column" style="display: none;">${item.amount_due || 0}</td>
                        <td>${item.agent_name}</td>
                        <td>${item.executive_name}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editToken(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteToken(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                showApiStatus('Data loaded successfully!', true);
            } catch (error) {
                // Hide loading spinner
                if (loadingSpinner) {
                    loadingSpinner.classList.add('d-none');
                }
                
                // Try localStorage tokens first; if empty, use sample data
                const localTokensRaw = localStorage.getItem(TOKENS_STORAGE_KEY);
                let sampleData = [
                    {
                        id: 1,
                        date: '2023-05-15',
                        location: 'India',
                        subLocation: 'Mumbai',
                        token: 'TKN001',
                        client_name: 'John Doe',
                        status: 'Completed',
                        charges: 500,
                        amount_due: 0,
                        agent_name: 'Agent1',
                        executive_name: 'Ramnath'
                    },
                    {
                        id: 2,
                        date: '2023-05-16',
                        location: 'International',
                        subLocation: 'USA',
                        token: 'TKN002',
                        client_name: 'Jane Smith',
                        status: 'Not Completed',
                        charges: 750,
                        amount_due: 750,
                        agent_name: 'Agent2',
                        executive_name: 'Ramnath'
                    }
                ];
                let fallbackData = [];
                if (localTokensRaw) {
                    try { fallbackData = JSON.parse(localTokensRaw); } catch {}
                }
                if (!Array.isArray(fallbackData) || fallbackData.length === 0) {
                    fallbackData = sampleData;
                }

                // Cache and populate the table with sample data
                tokenDataCache = fallbackData;
                const tableBody = document.getElementById('dataTableBody');
                tableBody.innerHTML = '';

                fallbackData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>${item.location}</td>
                        <td>${item.token}</td>
                        <td>${item.client_name}</td>
                        <td>${item.status}</td>
                        <td class="admin-only-column user-only-column" style="display: none;">${item.charges || 0}</td>
                        <td class="admin-only-column user-only-column agent-only-column" style="display: none;">${item.amount_due || 0}</td>
                        <td>${item.agent_name}</td>
                        <td>${item.executive_name}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editToken(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteToken(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                showApiStatus(Array.isArray(fallbackData) && fallbackData === sampleData 
                    ? 'Using sample data. Configure API connection to use your database.'
                    : 'Using locally saved tokens.', false);
            }
        }
        
        // Function to save token data to the database
        async function saveToken() {
            const tokenId = document.getElementById('tokenId').value;
            const tokenData = {
                date: document.getElementById('date').value,
                completionDate: document.getElementById('completionDate').value,
                location: document.getElementById('location').value,
                subLocation: document.getElementById('location').value === 'India' ? 
                    document.getElementById('subLocation').value : 
                    document.getElementById('countrySelect').value,
                token: document.getElementById('token').value,
                password: document.getElementById('password').value,
                clientName: document.getElementById('clientName').value,
                contact: document.getElementById('contact').value,
                whoWillShip: document.getElementById('whoWillShip').value,
                contactedClient: document.getElementById('contactedClient').value,
                status: document.getElementById('status').value,
                forwarded: document.getElementById('forwarded').value,
                charges: parseFloat(document.getElementById('charges').value) || 0,
                paymentReceived: parseFloat(document.getElementById('paymentReceived').value) || 0,
                amountDue: parseFloat(document.getElementById('amountDue').value) || 0,
                chargesToExecutive: parseFloat(document.getElementById('chargesToExecutive').value) || 0,
                agentName: document.getElementById('agentName').value,
                executiveName: document.getElementById('executiveName').value,
                margin: parseFloat(document.getElementById('margin').value) || 0,
                processBy: document.getElementById('processBy').value
            };

            // If API not configured, use local save path directly
            if (!isApiConfigured()) {
                let tokens = getLocalTokens();
                const tokenId = document.getElementById('tokenId').value;
                const normalized = {
                    id: tokenId ? parseInt(tokenId, 10) : undefined,
                    date: tokenData.date,
                    location: tokenData.location,
                    subLocation: tokenData.subLocation,
                    token: tokenData.token,
                    client_name: tokenData.clientName,
                    status: tokenData.status,
                    charges: tokenData.charges,
                    amount_due: tokenData.amountDue,
                    agent_name: tokenData.agentName,
                    executive_name: tokenData.executiveName
                };
                if (normalized.id) {
                    const idx = tokens.findIndex(t => t.id === normalized.id);
                    if (idx !== -1) tokens[idx] = { ...tokens[idx], ...normalized }; else tokens.push(normalized);
                } else {
                    const nextId = tokens.length > 0 ? Math.max(...tokens.map(t => t.id || 0)) + 1 : 1;
                    normalized.id = nextId;
                    tokens.push(normalized);
                }
                setLocalTokens(tokens);
                refreshTokensTableFromCache();
                resetForm();
                showApiStatus('Token saved locally (no backend).', true);
                return;
            }
            try {
                if (tokenId) {
                    // Update existing token
                    await apiRequest(`/tokens/${tokenId}`, 'PUT', tokenData);
                    showApiStatus('Token updated successfully!', true);
                } else {
                    // Create new token
                    await apiRequest('/tokens', 'POST', tokenData);
                    showApiStatus('Token created successfully!', true);
                }
                // Reset and reload from API
                resetForm();
                loadTokenData();
            } catch (error) {
                // Local fallback save
                let tokens = [];
                const raw = localStorage.getItem(TOKENS_STORAGE_KEY);
                if (raw) { try { tokens = JSON.parse(raw) || []; } catch {} }
                // Normalize keys to a consistent schema for display/export
                const normalized = {
                    id: tokenId ? parseInt(tokenId, 10) : undefined,
                    date: tokenData.date,
                    location: tokenData.location,
                    subLocation: tokenData.subLocation,
                    token: tokenData.token,
                    client_name: tokenData.clientName,
                    status: tokenData.status,
                    charges: tokenData.charges,
                    amount_due: tokenData.amountDue,
                    agent_name: tokenData.agentName,
                    executive_name: tokenData.executiveName
                };
                if (normalized.id) {
                    const idx = tokens.findIndex(t => t.id === normalized.id);
                    if (idx !== -1) tokens[idx] = { ...tokens[idx], ...normalized };
                    else tokens.push(normalized);
                } else {
                    const nextId = tokens.length > 0 ? Math.max(...tokens.map(t => t.id || 0)) + 1 : 1;
                    normalized.id = nextId;
                    tokens.push(normalized);
                }
                localStorage.setItem(TOKENS_STORAGE_KEY, JSON.stringify(tokens));
                tokenDataCache = tokens;
                showApiStatus('Token saved locally (no backend).', true);
                // Refresh table from cache
                const tableBody = document.getElementById('dataTableBody');
                tableBody.innerHTML = '';
                tokenDataCache.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>${item.location}</td>
                        <td>${item.token}</td>
                        <td>${item.client_name}</td>
                        <td>${item.status}</td>
                        <td class="admin-only-column user-only-column" style="display: none;">${item.charges || 0}</td>
                        <td class="admin-only-column user-only-column agent-only-column" style="display: none;">${item.amount_due || 0}</td>
                        <td>${item.agent_name || ''}</td>
                        <td>${item.executive_name || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editToken(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteToken(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                resetForm();
            }
        }
        
        // Function to edit token
        async function editToken(id) {
            // Prefer cache/local
            let token = tokenDataCache.find(t => t.id === id);
            if (!token) {
                // Try API
                try {
                    token = await apiRequest(`/tokens/${id}`);
                } catch (error) {
                    // ignore, will stay undefined
                }
            }
            if (!token) {
                showApiStatus('Token not found.', false);
                return;
            }
            document.getElementById('tokenId').value = token.id;
            document.getElementById('date').value = token.date && /\d{2}-\d{2}-\d{4}/.test(token.date) ? token.date.split('-').reverse().join('-') : (token.date || '');
            document.getElementById('completionDate').value = token.completion_date ? token.completion_date.split('-').reverse().join('-') : '';
            document.getElementById('location').value = token.location || '';
            updateSubLocationField();
            if (token.location === 'India') {
                document.getElementById('subLocation').value = token.subLocation || token.sub_location || '';
            } else {
                document.getElementById('countrySelect').value = token.subLocation || token.sub_location || '';
            }
            document.getElementById('token').value = token.token || '';
            document.getElementById('password').value = token.password || '';
            document.getElementById('clientName').value = token.client_name || token.clientName || '';
            document.getElementById('contact').value = token.contact || '';
            document.getElementById('whoWillShip').value = token.who_will_ship || token.whoWillShip || '';
            document.getElementById('contactedClient').value = token.contacted_client || token.contactedClient || '';
            document.getElementById('status').value = token.status || '';
            document.getElementById('forwarded').value = token.forwarded || '';
            document.getElementById('charges').value = token.charges || 0;
            document.getElementById('paymentReceived').value = token.payment_received || token.paymentReceived || 0;
            document.getElementById('amountDue').value = token.amount_due || token.amountDue || 0;
            document.getElementById('chargesToExecutive').value = token.charges_to_executive || token.chargesToExecutive || 0;
            document.getElementById('agentName').value = token.agent_name || token.agentName || '';
            document.getElementById('executiveName').value = token.executive_name || token.executiveName || '';
            document.getElementById('margin').value = token.margin || 0;
            document.getElementById('processBy').value = token.process_by || token.processBy || 'Doorstep';
            document.getElementById('submitBtnText').textContent = 'Update Token';
            document.getElementById('tokenForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Function to delete token
        async function deleteToken(id) {
            if (!confirm('Are you sure you want to delete this token?')) return;
            // If API not configured, delete locally
            if (!isApiConfigured()) {
                const tokens = getLocalTokens().filter(t => t.id !== id);
                setLocalTokens(tokens);
                refreshTokensTableFromCache();
                showApiStatus('Token deleted locally (no backend).', true);
                return;
            }
            try {
                await apiRequest(`/tokens/${id}`, 'DELETE');
                showApiStatus('Token deleted successfully!', true);
                loadTokenData();
            } catch (error) {
                // Local fallback delete
                let tokens = [];
                const raw = localStorage.getItem(TOKENS_STORAGE_KEY);
                if (raw) { try { tokens = JSON.parse(raw) || []; } catch {} }
                const newList = tokens.filter(t => t.id !== id);
                localStorage.setItem(TOKENS_STORAGE_KEY, JSON.stringify(newList));
                tokenDataCache = newList;
                // Refresh UI from cache
                refreshTokensTableFromCache();
                showApiStatus('Token deleted locally (no backend).', true);
            }
        }
        
        // User Management Functions
        
        // Load users into the table
        function loadUsers() {
            const tableBody = document.getElementById('usersTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td><span class="role-badge role-${user.role.toLowerCase()}">${user.role}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Add user function
        function addUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!username || !password) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Check if username already exists
            const existingUser = users.find(u => u.username === username);
            if (existingUser) {
                alert('Username already exists!');
                return;
            }
            
            // Add new user
            const newUser = {
                id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                username,
                password,
                role,
                status: 'Active'
            };
            users.push(newUser);
            
            // Save to localStorage
            localStorage.setItem('users', JSON.stringify(users));
            
            // Reload users table
            loadUsers();
            
            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newUserRole').value = 'user';
            
            showApiStatus('User added successfully!', true);
        }
        
        // Edit user (opens modal and populates fields)
        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            const idEl = document.getElementById('editUserId');
            const usernameEl = document.getElementById('editUsername');
            const passwordEl = document.getElementById('editPassword');
            const roleEl = document.getElementById('editUserRole');
            if (idEl) idEl.value = user.id;
            if (usernameEl) usernameEl.value = user.username;
            if (passwordEl) passwordEl.value = '';
            if (roleEl) roleEl.value = user.role;
            const modalEl = document.getElementById('editUserModal');
            if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }
        }
        
        // Delete user
        function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== id);
                localStorage.setItem('users', JSON.stringify(users));
                loadUsers();
                showApiStatus('User deleted successfully!', true);
            }
        }
        
        // Logout function
        function logout() {
            // Show login screen and hide main app
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Clear form
            document.getElementById('loginForm').reset();
            document.getElementById('loginAlert').innerHTML = '';
        }
        
        // Show about modal
        function showAbout() {
            alert('Token Management System v1.0\nA comprehensive solution for managing tokens and user access.');
        }
        
        // Placeholder functions for other features
        function exportData() {
            alert('Export data functionality will be implemented here.');
        }
        
        function refreshData() {
            loadTokenData();
        }
        
        function filterData() {
            alert('Filter data functionality will be implemented here.');
        }
        
        function updateSubLocationField() {
            const location = document.getElementById('location').value;
            const subLocationLabel = document.getElementById('subLocationLabel');
            const subLocationInput = document.getElementById('subLocation');
            const countrySelect = document.getElementById('countrySelect');
            
            if (location === 'India') {
                subLocationLabel.textContent = 'City';
                subLocationInput.style.display = 'block';
                countrySelect.style.display = 'none';
            } else if (location === 'International') {
                subLocationLabel.textContent = 'Country';
                subLocationInput.style.display = 'none';
                countrySelect.style.display = 'block';
            }
        }
        
        function updateFilterLocationField() {
            const location = document.getElementById('filterLocation').value;
            const countryFilterDiv = document.getElementById('countryFilterDiv');
            
            if (location === 'International') {
                countryFilterDiv.style.display = 'block';
            } else {
                countryFilterDiv.style.display = 'none';
            }
        }
        
        function calculateAmounts() {
            const charges = parseFloat(document.getElementById('charges').value) || 0;
            const paymentReceived = parseFloat(document.getElementById('paymentReceived').value) || 0;
            const chargesToExecutive = parseFloat(document.getElementById('chargesToExecutive').value) || 0;
            
            const amountDue = charges - paymentReceived;
            const margin = charges - chargesToExecutive;
            
            document.getElementById('amountDue').value = amountDue.toFixed(2);
            document.getElementById('margin').value = margin.toFixed(2);
        }
        
        function resetForm() {
            document.getElementById('tokenForm').reset();
            document.getElementById('submitBtnText').textContent = 'Add Token';
        }
        
        function applyFilters() {
            alert('Apply filters functionality will be implemented here.');
        }
        
        function clearFilters() {
            const filterStatus = document.getElementById('filterStatus');
            const filterLocation = document.getElementById('filterLocation');
            const filterFromDate = document.getElementById('filterFromDate');
            const filterToDate = document.getElementById('filterToDate');
            const filterAgent = document.getElementById('filterAgent');
            const filterCountry = document.getElementById('filterCountry');
            const countryFilterDiv = document.getElementById('countryFilterDiv');
            
            if (filterStatus) filterStatus.value = '';
            if (filterLocation) filterLocation.value = '';
            if (filterFromDate) filterFromDate.value = '';
            if (filterToDate) filterToDate.value = '';
            if (filterAgent) filterAgent.value = '';
            if (filterCountry) filterCountry.value = '';
            if (countryFilterDiv) countryFilterDiv.style.display = 'none';
            
            // Clear filtered table
            const filteredTableBody = document.getElementById('filteredTableBody');
            if (filteredTableBody) {
                filteredTableBody.innerHTML = '';
            }
        }
        
        function exportFilteredData() {
            // Simple export of current cache as CSV
            if (!tokenDataCache || tokenDataCache.length === 0) {
                showApiStatus('No filtered data to export.', false);
                return;
            }
            const headers = ['ID','Date','Location','Token','Client Name','Status','Charges','Amount Due','Agent','Executive'];
            const rows = tokenDataCache.map(r => [
                r.id, r.date && /\d{4}-\d{2}-\d{2}/.test(r.date) ? formatDate(r.date) : (r.date || ''), r.location||'', r.token||'',
                r.client_name || r.clientName || '', r.status||'', r.charges??'', r.amount_due ?? r.amountDue ?? '', r.agent_name||r.agentName||'', r.executive_name||r.executiveName||''
            ]);
            exportCSV('filtered_data.csv', headers, rows);
        }
        
        function generateAgentReport() {
            // For now, just export the agent report CSV
            exportAgentReport();
        }
        
        function bulkApplyAgentPayment() {
            alert('Bulk apply agent payment functionality will be implemented here.');
        }
        
        function markAllCompleted(type) {
            alert(`Mark all ${type} records as completed functionality will be implemented here.`);
        }
        
        function exportAgentReport() {
            if (!tokenDataCache || tokenDataCache.length === 0) {
                showApiStatus('No data available to export. Try refreshing data.', false);
                return;
            }
            const headers = ['ID','Date','Location','Token','Client Name','Status','Charges','Amount Due','Agent','Executive'];
            const rows = tokenDataCache
                .filter(r => (r.agent_name || r.agentName))
                .map(r => [
                    r.id,
                    r.date && /\d{4}-\d{2}-\d{2}/.test(r.date) ? formatDate(r.date) : (r.date || ''),
                    r.location || '',
                    r.token || '',
                    r.client_name || r.clientName || '',
                    r.status || '',
                    r.charges ?? '',
                    r.amount_due ?? r.amountDue ?? '',
                    r.agent_name || r.agentName || '',
                    r.executive_name || r.executiveName || ''
                ]);
            exportCSV('agent_report.csv', headers, rows);
            showApiStatus('Agent report exported.', true);
        }
        
        function generateExecutiveReport() {
            // For now, just export the executive report CSV
            exportExecutiveReport();
        }
        
        function bulkApplyExecutivePayment() {
            alert('Bulk apply executive payment functionality will be implemented here.');
        }
        
        function exportExecutiveReport() {
            if (!tokenDataCache || tokenDataCache.length === 0) {
                showApiStatus('No data available to export. Try refreshing data.', false);
                return;
            }
            const headers = ['ID','Date','Location','Token','Client Name','Status','Charges','Amount Due','Agent','Executive'];
            const rows = tokenDataCache
                .filter(r => (r.executive_name || r.executiveName))
                .map(r => [
                    r.id,
                    r.date && /\d{4}-\d{2}-\d{2}/.test(r.date) ? formatDate(r.date) : (r.date || ''),
                    r.location || '',
                    r.token || '',
                    r.client_name || r.clientName || '',
                    r.status || '',
                    r.charges ?? '',
                    r.amount_due ?? r.amountDue ?? '',
                    r.agent_name || r.agentName || '',
                    r.executive_name || r.executiveName || ''
                ]);
            exportCSV('executive_report.csv', headers, rows);
            showApiStatus('Executive report exported.', true);
        }

        // CSV Export helper
        function exportCSV(filename, headers, rows) {
            const escapeCell = (v) => {
                const s = (v === null || v === undefined) ? '' : String(v);
                if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            };
            const lines = [];
            if (headers && headers.length) lines.push(headers.map(escapeCell).join(','));
            rows.forEach(r => lines.push(r.map(escapeCell).join(',')));
            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function generateProfitReport() {
            alert('Generate profit report functionality will be implemented here.');
        }
        
        function addCountry() {
            alert('Add country functionality will be implemented here.');
        }
        
        function addAgent() {
            alert('Add agent functionality will be implemented here.');
        }
        
        function removeDuplicateTokens() {
            // Keep first occurrence by token (case-insensitive)
            const list = getLocalTokens();
            const seen = new Set();
            const cleaned = [];
            list.forEach(item => {
                const key = (item.token || '').toString().trim().toLowerCase();
                if (!key || !seen.has(key)) {
                    cleaned.push(item);
                    if (key) seen.add(key);
                }
            });
            setLocalTokens(cleaned);
            refreshTokensTableFromCache();
            showApiStatus('Duplicates removed (local).', true);
        }
        
        function fixAgentNames() {
            const list = getLocalTokens();
            const normalize = s => (s||'').toString().trim().replace(/\s+/g,' ');
            list.forEach(t => { t.agent_name = normalize(t.agent_name || t.agentName); });
            setLocalTokens(list);
            refreshTokensTableFromCache();
            showApiStatus('Agent names normalized (local).', true);
        }
        
        function fixClientNames() {
            const list = getLocalTokens();
            const titleCase = s => (s||'').toString().toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
            list.forEach(t => { t.client_name = titleCase((t.client_name || t.clientName || '').trim().replace(/\s+/g,' ')); });
            setLocalTokens(list);
            refreshTokensTableFromCache();
            showApiStatus('Client names normalized (local).', true);
        }
        
        function removeEmptyFields() {
            const list = getLocalTokens();
            list.forEach(t => {
                Object.keys(t).forEach(k => {
                    if (t[k] === '' || t[k] === null) delete t[k];
                });
            });
            setLocalTokens(list);
            refreshTokensTableFromCache();
            showApiStatus('Empty fields removed (local).', true);
        }
        
        function backupDatabase(silent=false) {
            const payload = {
                timestamp: Date.now(),
                tokens: getLocalTokens(),
                users: users
            };
            localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(payload));
            localStorage.setItem(BACKUP_LAST_TIME, String(payload.timestamp));
            scheduleNextBackup();
            updateBackupUI();
            const status = document.getElementById('backupStatus');
            if (status) {
                status.className = 'backup-status success';
                status.innerHTML = '<i class="fas fa-check-circle me-2"></i>Backup created successfully';
            }
            if (!silent) showApiStatus('Backup saved locally.', true);
        }
        
        function downloadDatabase() {
            let backup = null;
            try { backup = JSON.parse(localStorage.getItem(BACKUP_STORAGE_KEY)); } catch {}
            if (!backup) {
                backup = { timestamp: Date.now(), tokens: getLocalTokens(), users: users };
            }
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tms-backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showApiStatus('Backup downloaded.', true);
        }
        
        function restoreDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const data = JSON.parse(reader.result);
                        if (data && Array.isArray(data.tokens)) {
                            setLocalTokens(data.tokens);
                            refreshTokensTableFromCache();
                        }
                        if (data && Array.isArray(data.users)) {
                            users = data.users;
                            localStorage.setItem('users', JSON.stringify(users));
                            loadUsers();
                        }
                        localStorage.setItem(BACKUP_STORAGE_KEY, JSON.stringify(data));
                        localStorage.setItem(BACKUP_LAST_TIME, String(Date.now()));
                        updateBackupUI();
                        showApiStatus('Database restored from file.', true);
                    } catch (err) {
                        showApiStatus('Invalid backup file.', false);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // --- Added minimal stubs to avoid runtime errors for modal save actions ---
        function saveCountry() {
            // TODO: implement editing and persistence of country list
            alert('Country changes saved (stub).');
        }
        
        function saveAgent() {
            // TODO: implement editing and persistence of agent list
            alert('Agent changes saved (stub).');
        }
        
        function saveEditedUser() {
            const idEl = document.getElementById('editUserId');
            const usernameEl = document.getElementById('editUsername');
            const passwordEl = document.getElementById('editPassword');
            const roleEl = document.getElementById('editUserRole');
            const id = idEl ? parseInt(idEl.value, 10) : NaN;
            const username = usernameEl ? usernameEl.value.trim() : '';
            const password = passwordEl ? passwordEl.value : '';
            const role = roleEl ? roleEl.value : '';
            if (!id || !username || !role) {
                showApiStatus('Please fill in required fields', false);
                return;
            }
            const idx = users.findIndex(u => u.id === id);
            if (idx === -1) return;
            // Prevent duplicate username (except self)
            const dup = users.find(u => u.username === username && u.id !== id);
            if (dup) {
                showApiStatus('Username already exists!', false);
                return;
            }
            users[idx].username = username;
            if (password) users[idx].password = password; // keep existing if blank
            users[idx].role = role;
            localStorage.setItem('users', JSON.stringify(users));
            loadUsers();
            // Close modal
            const modalEl = document.getElementById('editUserModal');
            if (modalEl) {
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();
            }
            showApiStatus('User updated successfully!', true);
        }
    </script>
</body>
</html>